<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>District Police Range Kathmandu - Contact Directory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-hover {
            transition: all 0.2s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .search-highlight {
            background-color: #fef08a;
            padding: 0 2px;
            border-radius: 2px;
        }
        .sort-icon {
            transition: transform 0.2s;
        }
        .sort-asc .sort-icon {
            transform: rotate(180deg);
        }
        
        /* Mobile-specific styles */
        @media (max-width: 640px) {
            .tab-button {
                padding: 0.5rem;
                font-size: 0.8rem;
                min-width: 0;
                flex-grow: 1;
            }
            .tab-button i {
                margin-right: 0.25rem;
            }
            #contactsTable th, #contactsTable td {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            .modal-buttons {
                flex-wrap: wrap;
            }
            .modal-buttons button {
                margin-bottom: 0.5rem;
                width: 100%;
            }
            .contact-card {
                padding: 1rem;
            }
            .contact-card .flex {
                flex-direction: column;
            }
            .contact-card .flex-1 {
                margin-left: 0;
                margin-top: 1rem;
            }
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-900 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <img src="https://www.nepalpolice.gov.np/images/logo.png" alt="Nepal Police Logo" class="h-12 md:h-16 mr-3 md:mr-4">
                    <div>
                        <h1 class="text-xl md:text-2xl lg:text-3xl font-bold">District Police Range Kathmandu</h1>
                        <p class="text-blue-200 text-sm md:text-base">Contact Directory</p>
                    </div>
                </div>
                <div class="relative w-full md:w-64">
                    <input type="text" id="globalSearch" placeholder="Search contacts..." 
                           class="w-full px-4 py-2 rounded-full text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm md:text-base">
                    <button class="absolute right-3 top-2 text-gray-500">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-2 sm:px-4 py-4 md:py-8">
        <!-- Tabs Navigation -->
        <div class="flex overflow-x-auto border-b border-gray-200 mb-4 md:mb-8 no-scrollbar">
            <button id="floorsTab" class="tab-button active px-3 py-2 md:px-6 md:py-3 font-medium text-blue-700 border-b-2 border-blue-700 bg-gray-100 outline outline-1 outline-blue-700 whitespace-nowrap">
                <i class="fas fa-building mr-1 md:mr-2"></i>Floors
            </button>
            <button id="subOfficesTab" class="tab-button px-3 py-2 md:px-6 md:py-3 font-medium text-gray-600 hover:text-blue-700 bg-gray-100 outline outline-1 outline-blue-700 whitespace-nowrap">
                <i class="fas fa-sitemap mr-1 md:mr-2"></i>Sub Offices
            </button>
            <button id="otherOfficesTab" class="tab-button px-3 py-2 md:px-6 md:py-3 font-medium text-gray-600 hover:text-blue-700 bg-gray-100 outline outline-1 outline-blue-700 whitespace-nowrap">
                <i class="fas fa-network-wired mr-1 md:mr-2"></i>Other Offices
            </button>
            <button id="allContactsTab" class="tab-button px-3 py-2 md:px-6 md:py-3 font-medium text-gray-600 hover:text-blue-700 bg-gray-100 outline outline-1 outline-blue-700 whitespace-nowrap">
                <i class="fas fa-users mr-1 md:mr-2"></i>All Contacts
            </button>
        </div>

        <!-- Tab Contents -->
        <div class="tab-content">
            <!-- Floors Content -->
            <div id="floorsContent" class="tab-pane active fade-in">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6" id="floorsContainer">
                    <!-- Floors will be loaded here dynamically -->
                </div>
            </div>

            <!-- Subordinate Offices Content -->
            <div id="subOfficesContent" class="tab-pane hidden fade-in">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6" id="subOfficesContainer">
                    <!-- Subordinate offices will be loaded here dynamically -->
                </div>
            </div>

            <!-- Other Offices Content -->
            <div id="otherOfficesContent" class="tab-pane hidden fade-in">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6" id="otherOfficesContainer">
                    <!-- Other offices will be loaded here dynamically -->
                </div>
            </div>

            <!-- All Contacts Content -->
            <div id="allContactsContent" class="tab-pane hidden fade-in">
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-gray-800 text-white px-4 py-3">
                        <h3 class="font-bold text-lg">All Contacts</h3>
                    </div>
                    <div class="p-3 md:p-4">
                        <div class="mb-4">
                            <div class="flex flex-col sm:flex-row sm:flex-wrap items-center justify-between mb-3 md:mb-4 space-y-2 sm:space-y-0">
                                <div class="w-full sm:w-auto">
                                    <label for="contactFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by:</label>
                                    <select id="contactFilter" class="w-full sm:w-48 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm md:text-base">
                                        <option value="all">All Contacts</option>
                                        <!-- Options can be populated dynamically if needed -->
                                    </select>
                                </div>
                                <div class="w-full sm:w-auto">
                                    <label for="contactSort" class="block text-sm font-medium text-gray-700 mb-1">Sort by:</label>
                                    <select id="contactSort" class="w-full sm:w-48 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm md:text-base">
                                        <option value="name-asc">Name (A-Z)</option>
                                        <option value="name-desc">Name (Z-A)</option>
                                        <option value="designation-asc">Designation (A-Z)</option>
                                        <option value="designation-desc">Designation (Z-A)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="allContactsList" class="space-y-3 md:space-y-4">
                            <!-- Contacts will be loaded here dynamically -->
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                            <div class="text-sm text-gray-600">
                                Showing <span id="contactStart">0</span>-<span id="contactEnd">0</span> of <span id="contactTotal">0</span>
                            </div>
                            <div class="flex space-x-2">
                                <button id="prevPage" class="px-3 py-1 border border-gray-300 rounded bg-white text-gray-700 disabled:opacity-50 text-sm md:text-base">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button id="nextPage" class="px-3 py-1 border border-gray-300 rounded bg-white text-gray-700 text-sm md:text-base">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section Details Content (hidden by default) -->
            <div id="detailsContent" class="hidden fade-in">
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="flex items-center justify-between bg-blue-800 text-white px-4 py-3">
                        <h3 id="detailsTitle" class="font-bold text-base md:text-lg truncate"></h3>
                        <button id="backButton" class="px-3 py-1 bg-blue-700 hover:bg-blue-600 rounded flex items-center text-sm md:text-base">
                            <i class="fas fa-arrow-left mr-1 md:mr-2"></i> Back
                        </button>
                    </div>
                    <div class="p-3 md:p-4">
                        <div class="mb-4 md:mb-6">
                            <div class="flex flex-col md:flex-row md:flex-wrap items-center justify-between mb-3 md:mb-4 space-y-2 md:space-y-0">
                                <h4 class="text-base md:text-lg font-semibold text-gray-800">Contact List</h4>
                                <div class="relative w-full md:w-64">
                                    <input type="text" id="sectionSearch" placeholder="Search in this section..." 
                                           class="w-full px-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm md:text-base">
                                    <button class="absolute right-3 top-2 text-gray-500">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="contactsTable" class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sort-header" data-sort="designation">
                                                <div class="flex items-center">
                                                    Designation
                                                    <i class="fas fa-sort ml-1 sort-icon"></i>
                                                </div>
                                            </th>
                                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sort-header" data-sort="name">
                                                <div class="flex items-center">
                                                    Name
                                                    <i class="fas fa-sort ml-1 sort-icon"></i>
                                                </div>
                                            </th>
                                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Contact
                                            </th>
                                            <th scope="col" class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Actions
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="contactsList" class="bg-white divide-y divide-gray-200">
                                        <!-- Contacts will be loaded here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Contact Detail Modal -->
    <div id="contactModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true"></span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle w-full sm:max-w-2xl">
                <div class="bg-blue-800 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="closeModal" class="mt-0 w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-700 text-base font-medium text-white hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Close
                    </button>
                    <h3 class="text-lg leading-6 font-medium text-white truncate" id="modalTitle">Contact Details</h3>
                </div>
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4 overflow-y-auto max-h-[60vh]">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 sm:mx-0 sm:h-20 sm:w-20">
                            <i class="fas fa-user-tie text-blue-600 text-2xl"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                <div>
                                    <p class="text-sm text-gray-500">Designation</p>
                                    <p id="modalDesignation" class="text-base md:text-lg font-medium text-gray-900"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Name</p>
                                    <p id="modalName" class="text-base md:text-lg font-medium text-gray-900"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Call Sign</p>
                                    <p id="modalCallSign" class="text-gray-700"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Landline Number</p>
                                    <p id="modalLandline" class="text-gray-700"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Official Contact</p>
                                    <p id="modalContact1" class="text-gray-700"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Personal Contact</p>
                                    <p id="modalContact2" class="text-gray-700"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Email</p>
                                    <p id="modalEmail" class="text-gray-700"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Additional Details</p>
                                    <p id="modalDetails" class="text-gray-700"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 modal-buttons">
                    <button type="button" id="callLandline" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-phone mr-2"></i> Call Landline
                    </button>
                    <button type="button" id="callPrimary" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-mobile-alt mr-2"></i> Call Official
                    </button>
                    <button type="button" id="callSecondary" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-mobile mr-2"></i> Call Personal
                    </button>
                    <button type="button" id="emailContact" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-purple-600 text-base font-medium text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-envelope mr-2"></i> Email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 md:py-8">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8">
                <div>
                    <h3 class="text-lg font-semibold mb-3 md:mb-4">District Police Range Kathmandu</h3>
                    <p class="text-gray-400 text-sm md:text-base">Serving the community with dedication and professionalism.</p>
                    <div class="mt-3 md:mt-4 flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-white">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white">
                            <i class="fab fa-instagram"></i>
                        </a>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-3 md:mb-4">Quick Links</h3>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white text-sm md:text-base">Emergency Numbers</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white text-sm md:text-base">Crime Reporting</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white text-sm md:text-base">Traffic Updates</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white text-sm md:text-base">Recruitment</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-3 md:mb-4">Contact Information</h3>
                    <address class="text-gray-400 not-italic text-sm md:text-base">
                        <p><i class="fas fa-map-marker-alt mr-2"></i> Police Headquarters, Kathmandu</p>
                        <p class="mt-2"><i class="fas fa-phone mr-2"></i> Emergency: 100</p>
                        <p class="mt-2"><i class="fas fa-envelope mr-2"></i> info@kathmandupolice.gov.np</p>
                    </address>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-6 md:mt-8 pt-6 text-center text-gray-400 text-sm md:text-base">
                <p>Â© 2023 District Police Range Kathmandu. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        const API_BASE_URL = '/api';

        // Global state
        let allContacts = []; // To store all contacts fetched for "All Contacts" tab
        let currentTab = 'floors';
        let currentSectionDetails = null; // To store details of the currently viewed section
        let currentContacts = []; // Contacts for the currently viewed section or filtered list for "All Contacts"
        let currentSort = { field: 'name', direction: 'asc' };
        let currentPage = 1;
        const contactsPerPage = 10;
        let currentSearchTerm = ''; // For global search and section search
        let currentFilter = 'all'; // For "All Contacts" tab filter

        // DOM Elements
        const tabButtons = {
            floors: document.getElementById('floorsTab'),
            subOffices: document.getElementById('subOfficesTab'),
            otherOffices: document.getElementById('otherOfficesTab'),
            allContacts: document.getElementById('allContactsTab')
        };

        const tabContents = {
            floors: document.getElementById('floorsContent'),
            subOffices: document.getElementById('subOfficesContent'),
            otherOffices: document.getElementById('otherOfficesContent'),
            allContacts: document.getElementById('allContactsContent'),
            details: document.getElementById('detailsContent')
        };

        const floorsContainer = document.getElementById('floorsContainer');
        const subOfficesContainer = document.getElementById('subOfficesContainer');
        const otherOfficesContainer = document.getElementById('otherOfficesContainer');
        const backButton = document.getElementById('backButton');
        const detailsTitle = document.getElementById('detailsTitle');
        const contactsListEl = document.getElementById('contactsList'); // Renamed from contactsList to avoid conflict
        const allContactsListEl = document.getElementById('allContactsList'); // Renamed
        const globalSearch = document.getElementById('globalSearch');
        const sectionSearch = document.getElementById('sectionSearch');
        const contactFilter = document.getElementById('contactFilter');
        const contactSort = document.getElementById('contactSort');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const contactStart = document.getElementById('contactStart');
        const contactEnd = document.getElementById('contactEnd');
        const contactTotal = document.getElementById('contactTotal');

        // Modal elements
        const contactModal = document.getElementById('contactModal');
        const closeModal = document.getElementById('closeModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalDesignation = document.getElementById('modalDesignation');
        const modalName = document.getElementById('modalName');
        const modalCallSign = document.getElementById('modalCallSign');
        const modalLandline = document.getElementById('modalLandline');
        const modalContact1 = document.getElementById('modalContact1');
        const modalContact2 = document.getElementById('modalContact2');
        const modalEmail = document.getElementById('modalEmail');
        const modalDetails = document.getElementById('modalDetails');
        const callLandline = document.getElementById('callLandline');
        const callPrimary = document.getElementById('callPrimary');
        const callSecondary = document.getElementById('callSecondary');
        const emailContact = document.getElementById('emailContact');

        // Utility to fetch data
        async function fetchData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    console.error(`HTTP error! status: ${response.status} for URL ${url}`);
                    return null;
                }
                return await response.json();
            } catch (error) {
                console.error(`Fetch error for URL ${url}:`, error);
                return null;
            }
        }

        // Render functions
        async function renderCategories(categoryType, containerElement, iconClass, itemBgHoverClass) {
            containerElement.innerHTML = '<p class="text-gray-500">Loading data...</p>';
            const categories = await fetchData(`${API_BASE_URL}/categories/type/${categoryType}`);
            if (!categories || categories.length === 0) {
                containerElement.innerHTML = `<p class="text-gray-500">No ${categoryType.toLowerCase()} data available.</p>`;
                return;
            }
            containerElement.innerHTML = ''; // Clear loading message

            for (const category of categories) {
                const categoryCard = document.createElement('div');
                categoryCard.className = 'bg-white rounded-lg shadow-md overflow-hidden card-hover';

                let sectionsHtml = '<p class="text-xs text-gray-400 px-3 py-2">Loading sections...</p>';
                const sections = await fetchData(`${API_BASE_URL}/sections/category/${category.categoryId}`);

                if (sections && sections.length > 0) {
                    sectionsHtml = sections.map(section => `
                        <li>
                            <button class="section-btn w-full text-left px-3 py-2 bg-gray-100 hover:${itemBgHoverClass} rounded flex justify-between items-center text-sm md:text-base" data-section-id="${section.sectionId}" data-category-name="${category.categoryName}" data-section-name="${section.sectionName}">
                                <span>${section.sectionName}</span>
                                <i class="fas fa-chevron-right text-sm text-gray-500"></i>
                            </button>
                        </li>
                    `).join('');
                } else {
                    sectionsHtml = `<li class="px-3 py-2 text-xs text-gray-400">No sections found.</li>`;
                }

                categoryCard.innerHTML = `
                    <div class="${category.color || 'bg-gray-700'} text-white px-4 py-3">
                        <h3 class="font-bold text-base md:text-lg">${category.categoryName}</h3>
                    </div>
                    <div class="p-3 md:p-4">
                        <div class="mb-3 md:mb-4">
                            <h4 class="font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas ${iconClass} mr-2"></i> Sections
                            </h4>
                            <ul class="space-y-2">${sectionsHtml}</ul>
                        </div>
                    </div>
                `;
                containerElement.appendChild(categoryCard);
            }
            // Add event listeners after all cards are rendered
            containerElement.querySelectorAll('.section-btn').forEach(button => {
                button.addEventListener('click', () => {
                    showSectionDetails(button.dataset.sectionId, button.dataset.categoryName, button.dataset.sectionName);
                });
            });
        }

        function renderFloors() {
            renderCategories('Floor', floorsContainer, 'fa-building text-blue-600', 'bg-blue-50');
        }

        function renderSubOffices() {
            renderCategories('SubOffice', subOfficesContainer, 'fa-sitemap text-green-600', 'bg-green-50');
        }

        function renderOtherOffices() {
            renderCategories('OtherOffice', otherOfficesContainer, 'fa-network-wired text-purple-600', 'bg-purple-50');
        }

        async function showSectionDetails(sectionId, categoryName, sectionName) {
            tabContents[currentTab].classList.add('hidden');
            tabContents.details.classList.remove('hidden');

            // Fetch full section details if needed for more info, though categoryName and sectionName are passed
            // For now, we use passed names.
            // const sectionData = await fetchData(`${API_BASE_URL}/sections/${sectionId}`);
            // if (!sectionData) {
            //     detailsTitle.textContent = 'Error loading section';
            //     contactsListEl.innerHTML = '<tr><td colspan="4">Could not load section details.</td></tr>';
            //     return;
            // }
            // currentSectionDetails = sectionData;
            // detailsTitle.textContent = `${sectionData.category.categoryName} - ${sectionData.sectionName}`;

            detailsTitle.textContent = `${categoryName} - ${sectionName}`;
            currentSectionDetails = { sectionId, sectionName, categoryName }; // Store basic info

            contactsListEl.innerHTML = '<tr><td colspan="4" class="text-center py-4">Loading contacts...</td></tr>';
            const contacts = await fetchData(`${API_BASE_URL}/contacts/section/${sectionId}`);

            currentContacts = contacts || [];
            currentSearchTerm = ''; // Reset section search
            sectionSearch.value = '';
            currentSort = { field: 'name', direction: 'asc' }; // Reset sort for section
            document.querySelectorAll('#detailsContent .sort-header').forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
                if(h.dataset.sort === currentSort.field) h.classList.add('sort-asc');
            });
            renderSectionContacts();
        }

        function renderSectionContacts() {
            if (!currentContacts) {
                contactsListEl.innerHTML = '<tr><td colspan="4" class="text-center py-4">No contacts found or error loading.</td></tr>';
                return;
            }

            let filteredContacts = [...currentContacts];

            if (currentSearchTerm) {
                const lowerSearchTerm = currentSearchTerm.toLowerCase();
                filteredContacts = filteredContacts.filter(contact =>
                    (contact.name && contact.name.toLowerCase().includes(lowerSearchTerm)) ||
                    (contact.designation && contact.designation.toLowerCase().includes(lowerSearchTerm)) ||
                    (contact.callSign && contact.callSign.toLowerCase().includes(lowerSearchTerm)) ||
                    (contact.contact1 && contact.contact1.includes(lowerSearchTerm)) ||
                    (contact.contact2 && contact.contact2.includes(lowerSearchTerm)) ||
                    (contact.landline && contact.landline.includes(lowerSearchTerm)) ||
                    (contact.email && contact.email.toLowerCase().includes(lowerSearchTerm))
                );
            }

            filteredContacts.sort((a, b) => {
                const fieldA = a[currentSort.field]?.toLowerCase() || '';
                const fieldB = b[currentSort.field]?.toLowerCase() || '';
                return currentSort.direction === 'asc' ? fieldA.localeCompare(fieldB) : fieldB.localeCompare(fieldA);
            });

            if (filteredContacts.length === 0) {
                contactsListEl.innerHTML = '<tr><td colspan="4" class="text-center py-4">No contacts match your criteria.</td></tr>';
                return;
            }

            contactsListEl.innerHTML = '';
            filteredContacts.forEach(contact => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                const highlight = (text) => text && currentSearchTerm ? text.replace(new RegExp(currentSearchTerm, 'gi'), match => `<span class="search-highlight">${match}</span>`) : text || '';

                row.innerHTML = `
                    <td class="px-3 md:px-6 py-3 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${highlight(contact.designation)}</div>
                    </td>
                    <td class="px-3 md:px-6 py-3 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${highlight(contact.name)}</div>
                    </td>
                    <td class="px-3 md:px-6 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${highlight(contact.contact1)}</div>
                        ${contact.contact2 ? `<div class="text-xs text-gray-500">${highlight(contact.contact2)}</div>` : ''}
                    </td>
                    <td class="px-3 md:px-6 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button class="view-details text-blue-600 hover:text-blue-900 mr-2 md:mr-3" data-contact-pk="${contact.contactPk}">
                            <i class="fas fa-eye mr-1"></i> <span class="hidden sm:inline">View</span>
                        </button>
                        <a href="tel:${contact.contact1}" class="text-green-600 hover:text-green-900">
                            <i class="fas fa-phone mr-1"></i> <span class="hidden sm:inline">Call</span>
                        </a>
                    </td>
                `;
                contactsListEl.appendChild(row);
            });

            document.querySelectorAll('#contactsList .view-details').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const pk = e.currentTarget.dataset.contactPk;
                    // Find contact from currentContacts list or fetch if not detailed enough
                    let contactDetail = currentContacts.find(c => c.contactPk.toString() === pk);
                    if (!contactDetail) { // Fallback to fetch if somehow not in list (should be)
                        contactDetail = await fetchData(`${API_BASE_URL}/contacts/${pk}`);
                    }
                    if(contactDetail) showContactModal(contactDetail);
                    else alert('Contact details not found.');
                });
            });
        }

        async function initializeAllContacts() {
            allContactsListEl.innerHTML = '<p class="text-gray-500 p-4">Loading all contacts...</p>';
            const contacts = await fetchData(`${API_BASE_URL}/contacts`);
            if (contacts) {
                allContacts = contacts;
                renderAllContacts(); // Initial render
            } else {
                allContactsListEl.innerHTML = '<p class="text-red-500 p-4">Failed to load contacts.</p>';
                allContacts = [];
            }
        }

        function renderAllContacts() {
            let filtered = [...allContacts];

            if (currentSearchTerm) {
                const lowerSearchTerm = currentSearchTerm.toLowerCase();
                filtered = filtered.filter(contact =>
                    (contact.name && contact.name.toLowerCase().includes(lowerSearchTerm)) ||
                    (contact.designation && contact.designation.toLowerCase().includes(lowerSearchTerm)) ||
                    (contact.callSign && contact.callSign.toLowerCase().includes(lowerSearchTerm))
                );
            }

            // TODO: Implement currentFilter for 'All Contacts' if specific filter options are defined
            // For now, contactFilter select is static. If it had dynamic options based on roles/teams:
            // if (currentFilter !== 'all') {
            //    filtered = filtered.filter(c => c.someProperty === currentFilter);
            // }


            filtered.sort((a, b) => {
                const fieldA = a[currentSort.field]?.toLowerCase() || '';
                const fieldB = b[currentSort.field]?.toLowerCase() || '';
                return currentSort.direction === 'asc' ? fieldA.localeCompare(fieldB) : fieldB.localeCompare(fieldA);
            });

            const totalResults = filtered.length;
            contactTotal.textContent = totalResults;
            const startIndex = (currentPage - 1) * contactsPerPage;
            const endIndex = Math.min(startIndex + contactsPerPage, totalResults);
            const pageContacts = filtered.slice(startIndex, endIndex);

            contactStart.textContent = totalResults > 0 ? startIndex + 1 : 0;
            contactEnd.textContent = endIndex;
            prevPage.disabled = currentPage === 1;
            nextPage.disabled = currentPage * contactsPerPage >= totalResults;

            allContactsListEl.innerHTML = '';
            if (pageContacts.length === 0) {
                allContactsListEl.innerHTML = '<p class="text-gray-500 p-4">No contacts match your criteria.</p>';
                return;
            }

            pageContacts.forEach(contact => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow p-4 md:p-6 hover:shadow-md transition-shadow duration-200 contact-card';
                const highlight = (text) => text && currentSearchTerm ? text.replace(new RegExp(currentSearchTerm, 'gi'), match => `<span class="search-highlight">${match}</span>`) : text || '';

                card.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0 h-12 w-12 rounded-full bg-blue-100 flex items-center justify-center">
                            <i class="fas fa-user-tie text-blue-600 text-xl"></i>
                        </div>
                        <div class="ml-3 md:ml-4 flex-1">
                            <div class="flex items-center justify-between">
                                <h3 class="text-base md:text-lg font-medium text-gray-900">${highlight(contact.name)}</h3>
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    ${highlight(contact.designation)}
                                </span>
                            </div>
                            <p class="text-xs md:text-sm text-gray-600 mt-1">Call Sign: ${highlight(contact.callSign || 'N/A')}</p>
                            <div class="mt-2 flex flex-wrap gap-2">
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                    <i class="fas fa-mobile-alt mr-1 text-gray-500"></i> ${highlight(contact.contact1)}
                                </span>
                                ${contact.landline ? `
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                    <i class="fas fa-phone mr-1 text-gray-500"></i> ${highlight(contact.landline)}
                                </span>` : ''}
                            </div>
                            <div class="mt-3 flex flex-wrap gap-2">
                                <button class="view-details-all inline-flex items-center px-3 py-1 border border-gray-300 shadow-sm text-xs md:text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" data-contact-pk="${contact.contactPk}">
                                    <i class="fas fa-eye mr-1"></i> Details
                                </button>
                                <a href="tel:${contact.contact1}" class="inline-flex items-center px-3 py-1 border border-gray-300 shadow-sm text-xs md:text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    <i class="fas fa-phone mr-1"></i> Call
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                allContactsListEl.appendChild(card);
            });

            document.querySelectorAll('#allContactsList .view-details-all').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const pk = e.currentTarget.dataset.contactPk;
                    const contactDetail = allContacts.find(c => c.contactPk.toString() === pk); // Assumes allContacts has full details
                    if(contactDetail) showContactModal(contactDetail);
                    else { // Fallback if somehow not found or if allContacts doesn't have full details
                        const fetchedContact = await fetchData(`${API_BASE_URL}/contacts/${pk}`);
                        if(fetchedContact) showContactModal(fetchedContact);
                        else alert('Contact details not found.');
                    }
                });
            });
        }

        function showContactModal(contact) {
            modalTitle.textContent = `${contact.designation} - ${contact.name}`;
            modalDesignation.textContent = contact.designation || 'N/A';
            modalName.textContent = contact.name || 'N/A';
            modalCallSign.textContent = contact.callSign || 'N/A';
            modalLandline.textContent = contact.landline || 'N/A';
            modalContact1.textContent = contact.contact1 || 'N/A';
            modalContact2.textContent = contact.contact2 || 'N/A';
            modalEmail.textContent = contact.email || 'N/A';
            modalDetails.textContent = contact.details || 'No additional details';

            callLandline.onclick = () => { if (contact.landline) window.location.href = `tel:${contact.landline}`; };
            callPrimary.onclick = () => { if (contact.contact1) window.location.href = `tel:${contact.contact1}`; };
            callSecondary.onclick = () => { if (contact.contact2) window.location.href = `tel:${contact.contact2}`; };
            emailContact.onclick = () => { if (contact.email) window.location.href = `mailto:${contact.email}`; };

            contactModal.classList.remove('hidden');
        }

        // Event Listeners
        function switchTab(tabName) {
            currentTab = tabName;
            Object.values(tabContents).forEach(content => content.classList.add('hidden'));
            tabContents[tabName].classList.remove('hidden');

            Object.values(tabButtons).forEach(button => {
                button.classList.remove('active', 'text-blue-700', 'border-blue-700');
                button.classList.add('text-gray-600', 'hover:text-blue-700');
            });
            tabButtons[tabName].classList.add('active', 'text-blue-700', 'border-blue-700');
            tabButtons[tabName].classList.remove('text-gray-600', 'hover:text-blue-700');

            currentSearchTerm = ''; // Reset search term on tab switch
            globalSearch.value = '';
            if (tabName === 'allContacts') { // If switching to all contacts, ensure list is current
                currentPage = 1;
                renderAllContacts();
            } else if (tabName === 'details') {
                // This case should ideally not be triggered by main tabs
            } else {
                // For category tabs, data is loaded when they are rendered if not already
            }
        }

        tabButtons.floors.addEventListener('click', () => switchTab('floors'));
        tabButtons.subOffices.addEventListener('click', () => switchTab('subOffices'));
        tabButtons.otherOffices.addEventListener('click', () => switchTab('otherOffices'));
        tabButtons.allContacts.addEventListener('click', () => switchTab('allContacts'));

        backButton.addEventListener('click', () => {
            tabContents.details.classList.add('hidden');
            // Determine which category tab was active before details view.
            // This simple version defaults to floors, but a more robust solution might store previous tab.
            // For now, we rely on `currentTab` still holding the originating tab like 'floors', 'subOffices', etc.
            if(tabContents[currentTab]) {
                 tabContents[currentTab].classList.remove('hidden');
            } else {
                 tabContents.floors.classList.remove('hidden'); // Fallback
            }
        });

        globalSearch.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value.toLowerCase();
            if (currentTab === 'allContacts') {
                currentPage = 1; // Reset to first page for new search
                renderAllContacts();
            }
            // For other tabs, global search might not apply or would be complex.
            // For section details view, it's handled by sectionSearch
        });

        sectionSearch.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value.toLowerCase();
            if (currentTab === 'details' || tabContents.details.classList.contains('active')) { // ensure we are in details view
                 renderSectionContacts();
            }
        });

        contactFilter.addEventListener('change', (e) => {
            currentFilter = e.target.value;
            currentPage = 1;
            if (currentTab === 'allContacts') renderAllContacts();
        });

        contactSort.addEventListener('change', (e) => {
            const [field, direction] = e.target.value.split('-');
            currentSort = { field, direction };
            if (currentTab === 'allContacts') renderAllContacts();
        });

        document.querySelectorAll('#detailsContent .sort-header').forEach(header => {
            header.addEventListener('click', () => {
                const field = header.dataset.sort;
                if (currentSort.field === field) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.field = field;
                    currentSort.direction = 'asc';
                }
                document.querySelectorAll('#detailsContent .sort-header').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
                header.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                renderSectionContacts();
            });
        });

        prevPage.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                if (currentTab === 'allContacts') renderAllContacts();
            }
        });

        nextPage.addEventListener('click', () => {
            // Max page check is done within renderAllContacts by disabling button
            currentPage++;
            if (currentTab === 'allContacts') renderAllContacts();
        });

        closeModal.addEventListener('click', () => contactModal.classList.add('hidden'));

        // Initial data load
        async function initializeApp() {
            renderFloors();
            renderSubOffices();
            renderOtherOffices();
            await initializeAllContacts(); // Fetches all contacts and does an initial render
            switchTab('floors'); // Set default tab
        }

        initializeApp();
    </script>
</body>
</html>
